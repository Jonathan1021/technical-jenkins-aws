pipeline {
    agent any

    parameters {
        string(name: 'Email', defaultValue: '', description: 'Ejemplo: example@hdiexample.com.co')
        choice(name: 'Action', choices: ['Create Secret', 'Update Secret'], description: 'Seleccione la opcion a ejecutar')
    }

    environment {
        USER_INPUT = null
        QUERY = null
    }

    options {
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }

    stages {
        stage('Create Secret') {
            when {
                expression {
                    params.Action == "Create Secret"
                }
            }
            steps {
                script {
                    USER_INPUT = input message: "Configure Secret", 
                                ok: "Execute",
                                submitterParameter: 'userSubmitter',
                                parameters: [
                                    string(name: 'TrouxID', description: 'Input tag TrouxId. Example: de34e7b8-adbb-4bcd-b7df-869c45b86308'),
                                    string(name: 'Project Name', description: 'Name of the project that the secret is associated with. Example: low-touch'),
                                    string(name: 'Suffix', defaultValue: '', description: 'Name of the project that the secret is associated with. Example: low-touch'),
                                    text(name: 'Json', defaultValue: '{"key": "value"}',  description: 'Key/Value pairs')
                                ]
                    sh """
                    echo Create Secret...
                    """                 
                }
            }
        }

        stage('Update Secret') {
            when {
                expression {
                    params.Action == "Update Secret"
                }
            }
            steps {
                script {
                    def jsonInput = '{"host": "John Doe", "email": "johndoe@example.com", "age": "30", "user_password": "mySecretPassword"}'

                    // Convertimos el JSON a un objeto Groovy
                    def jsonObject = readJSON text: jsonInput

                    // Creamos una lista para los par치metros de input
                    def inputParams = []

                    // Recorremos el JSON y generamos un input de tipo string para cada clave/valor
                    jsonObject.each { key, value ->
                        if (key.contains("password") || key.contains("secret") || key.contains("pwd")) {
                            // Si el nombre de la clave contiene 'password', 'secret' o 'pwd', usamos un input de tipo password
                            inputParams.add(password(
                                name: key,
                                defaultValue: value,
                                description: "Introduce la contrase침a para: ${key}"
                            ))
                        } else {
                            // Para otras claves, usamos un input de tipo string
                            inputParams.add(string(
                                name: key,
                                defaultValue: value,
                                description: "Introduce el valor para: ${key}"
                            ))
                        }
                    }

                    // Realizamos el input din치mico
                    def userInput = input message: 'Por favor, completa los siguientes campos:', parameters: inputParams

                    // Mostrar los valores ingresados (es recomendable no mostrar contrase침as por razones de seguridad)
                    echo "Valores ingresados: ${userInput}"

                    // Ejemplo de uso en un comando shell
                    sh """
                    echo Update Secret...
                    """
                }
            }
        }

        stage('Create/Update Secret') {
            steps {
                script {
                    sh """
                    echo Create/Update
                    """
                }
            }
        }

        stage('Approvers') {
            when {
                expression {
                    return params.Stage == "prod" || params.Stage == "nonprod" || params.Stage == "uat"
                }
            }
            steps {
                script {
                    USER_INPUT = input message: "Do you approve the execution of the following query?\n\n${QUERY}", 
                                        ok: "Execute",
                                        submitterParameter: 'userSubmitter'
                }
            }
        }

        stage('Execute Query PartiQL') {
            steps {
                script {
                    sh """
                    echo Executing... ${QUERY}
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        // success {
        //     script {
        //         notificationSuccess()
        //     }
        // }
        // failure {
        //     script {
        //         notificationError()
        //     }
        // }    
    }
}

def notificationSuccess() {
    def subject = "${Email}"
    def bodyText = ""
    subject = "[${params.Stage}] - Released Success in ${env.JOB_NAME} - ${params.ArtifactoryId}"
    bodyText = """
    Hi there!!

    Deployment successful! Artifactory ID: ${params.ArtifactoryId} to the ${params.Stage} environment.

    See job here: ${env.BUILD_URL}

    See log here: ${env.BUILD_URL}consoleText
    """
    echo "Sending email with subject '${Email}' and content:\n${bodyText}"
}

def notificationError() {
    def subject = "${Email}"
    def bodyText = ""
    subject = "[${params.Stage}] - Released Error in ${env.JOB_NAME} - ${params.ArtifactoryId}"
    bodyText = """
    Hi there!!

    Deployment successful! Artifactory ID: ${params.ArtifactoryId} to the ${params.Stage} environment. 

    See job here: ${env.BUILD_URL}

    See log here: ${env.BUILD_URL}consoleText
    """
    echo "Sending email with subject '${Email}' and content:\n${bodyText}"
}